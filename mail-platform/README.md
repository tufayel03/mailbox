# Mail Platform (Native Stack, No Docker)

Private multi-domain mail hosting for personal/internal use.

This project includes:
- Native Ubuntu mail stack (Postfix, Dovecot, Rspamd, Redis, PostgreSQL, Nginx, Fail2ban, UFW)
- Internal admin panel (Node.js + Express + PostgreSQL + EJS)
- Domain manager + DNS generator/checker
- Mailbox manager
- Outbound abuse guard (`50/hour`, `200/day`) + warning/disable workflow

## Project Layout

```text
mail-platform/
├── setup-mailserver.sh
├── panel/
│   ├── server.js
│   ├── mailServerApi.js
│   ├── db.sql
│   ├── .env.example
│   ├── routes/
│   ├── views/
│   └── public/
└── docs/
```

## 1) Server Setup (Ubuntu 24.04)

Run on your Ubuntu server:

```bash
cd /path/to/mail-platform
chmod +x setup-mailserver.sh
sudo ./setup-mailserver.sh \
  --hostname mail.mailhost.com \
  --timezone UTC \
  --admin-email you@example.com \
  --acme auto \
  --imap-starttls off \
  --install-panel-service on
```

Optional flags:

```bash
# skip Let's Encrypt for now (keeps 80/443 open)
sudo ./setup-mailserver.sh --hostname mail.mailhost.com --acme skip

# do not modify system hostname
sudo ./setup-mailserver.sh --hostname mail.mailhost.com --no-hostname-change

# open IMAP STARTTLS 143 in addition to IMAPS 993
sudo ./setup-mailserver.sh --hostname mail.mailhost.com --imap-starttls on

# skip panel service installation
sudo ./setup-mailserver.sh --hostname mail.mailhost.com --install-panel-service off
```

What the setup script configures:
- Postfix, Dovecot, Rspamd, Redis, PostgreSQL, Nginx, Certbot
- Firewall ports: `22,25,80,443,465,587,993,4190` (plus `143` if enabled)
- Fail2ban `sshd` jail
- Rspamd ratelimit config with configtest + rollback safety
- Panel `.env` DB and host values

## 2) Panel Setup and Run

Production (recommended):

```bash
cd /path/to/mail-platform/panel
sudo systemctl status mail-platform-panel --no-pager
curl -fsS http://127.0.0.1:3001/healthz
```

Manual mode (if service install skipped):

```bash
cd /path/to/mail-platform/panel
cp .env.example .env
```

Edit `.env` at minimum:
- `SESSION_SECRET` = long random string
- `DATABASE_URL` = panel DB connection
- `ADMIN_PASSWORD` = your first admin password
- `MAIL_HOSTNAME` = your mail host (`mail.mailhost.com`)

Install and initialize:

```bash
npm install
npm run db:init
npm start
```

Panel URL:
- `http://127.0.0.1:3001/login`

Remote access (recommended via SSH tunnel):

```bash
ssh -L 3001:127.0.0.1:3001 user@your-server
```

Then open `http://127.0.0.1:3001/login` on your local machine.

## 3) First Login

Use:
- Username: value of `ADMIN_USER` in `.env` (default `admin`)
- Password: value of `ADMIN_PASSWORD` in `.env`

If login fails, re-run:

```bash
cd /path/to/mail-platform/panel
npm run db:init
```

If panel service generated admin password automatically, read:

```bash
sudo cat /root/mail-platform-admin-password.txt
```

## 4) Add Your First Domain

1. Go to `Domains`.
2. In `Add Domain`, enter:
- Domain: `yourdomain.com`
- Description: optional
3. Click `Add Domain`.
4. Click `DNS JSON` to view generated DNS values.
5. Publish those records in your DNS provider.
6. Click `Check DNS` until records show pass.

Expected records generated by panel:
- `MX` for `@` -> `mail.mailhost.com` (priority 10)
- `TXT SPF` for `@` -> `v=spf1 mx -all`
- `TXT DKIM` for `mail._domainkey` -> generated key from panel
- `TXT DMARC` for `_dmarc` -> quarantine policy
- `CNAME autodiscover` -> `mail.mailhost.com`
- `CNAME autoconfig` -> `mail.mailhost.com`

Important:
- Your server IP PTR/rDNS must point to `mail.mailhost.com`
- `A` record for `mail.mailhost.com` must point to your server public IP

## 5) Create Your First Mailbox

1. Go to `Mailboxes`.
2. In `Create Mailbox`, fill:
- Local part: `admin`
- Domain: `yourdomain.com`
- Name: `Domain Admin`
- Password: strong password (8+ chars)
- Quota: e.g. `3072` MB
3. Click `Create Mailbox`.

Result mailbox:
- `admin@yourdomain.com`

Available mailbox actions:
- Enable / Disable
- Delete
- Set quota
- Reset password

## 6) DNS Check and Fix Workflow

Use `Domains -> Check DNS`.

If `FAIL`:
- `MX` fail: fix MX target and priority.
- `SPF` fail: ensure SPF TXT for root domain matches expected.
- `DKIM` fail: ensure `mail._domainkey` TXT contains full generated key.
- `DMARC` fail: ensure `_dmarc` TXT exists.
- `autodiscover/autoconfig` fail: fix CNAME target.

## 7) Client Setup (Gmail / IMAP-SMTP Apps)

Incoming IMAP:
- Server: `mail.mailhost.com`
- Port: `993`
- Security: SSL/TLS
- Username: full mailbox (`admin@yourdomain.com`)
- Password: mailbox password

Outgoing SMTP:
- Server: `mail.mailhost.com`
- Port: `587` (STARTTLS) or `465` (SSL/TLS)
- Auth: required
- Username: full mailbox
- Password: mailbox password

## 8) Security and Sending Limits

Configured limits:
- `50/hour` per authenticated mailbox
- `200/day` per authenticated mailbox

Worker behavior (`Security` page):
- 1st rate-limit hit in 7 days -> warning state
- 2nd rate-limit hit in 7 days -> mailbox auto-disabled
- Admin can manually re-enable mailbox in `Mailboxes`

## 9) Daily Operations

Check service health:

```bash
systemctl status postfix dovecot rspamd redis-server postgresql nginx --no-pager
tail -n 120 /var/log/rspamd/rspamd.log
sudo ufw status verbose
```

Start panel in production mode:

```bash
sudo systemctl restart mail-platform-panel
sudo journalctl -u mail-platform-panel -f
```

## 10) Troubleshooting

`127.0.0.1 refused to connect`:
- Panel is not running. Start it with `npm run dev` or `npm start`.

`Invalid credentials` on login:
- Verify `.env` `ADMIN_PASSWORD`.
- Run `npm run db:init` again.

`Add domain failed`:
- Check panel logs for DKIM write/reload permission errors.
- Ensure panel user can write DKIM path and reload Rspamd.

DNS check not passing:
- Wait DNS propagation and retry.
- Confirm exact record name/value (no truncation).

Mail send issues to Gmail:
- Verify PTR/rDNS, SPF, DKIM, DMARC alignment.
- Warm up sending volume gradually.

## 11) Additional Docs

- `docs/run-commands.md`
- `docs/production-deploy.md`
- `docs/first-domain-mailbox.md`
- `docs/post-install-checklist.md`
- `docs/gmail-setup.md`
- `docs/domain-warmup.md`
