<%- include('partials/header', { pageTitle, currentUser, flash }) %>

<%
  const mailboxRows = Array.isArray(mailboxes) ? mailboxes : [];
  const enabledCount = mailboxRows.filter((item) => String(item.active) === '1').length;
  const warnedCount = mailboxRows.filter((item) => item.localState && item.localState.status === 'warning').length;
%>

<section class="panel-grid mailboxes-grid">
  <article class="panel-card">
    <div class="card-head">
      <div>
        <h1 class="section-title">Mailbox Matrix</h1>
        <p class="muted">Provision accounts, control quota, and enforce mailbox states.</p>
      </div>
      <span class="badge-pill"><i data-lucide="mailbox"></i><%= mailboxRows.length %> mailboxes</span>
    </div>

    <div class="stats-strip three">
      <div class="stat-block">
        <span class="stat-label">Enabled</span>
        <span class="stat-value ok"><%= enabledCount %></span>
      </div>
      <div class="stat-block">
        <span class="stat-label">Warnings</span>
        <span class="stat-value warn"><%= warnedCount %></span>
      </div>
      <div class="stat-block">
        <span class="stat-label">Filter</span>
        <span class="stat-value info"><%= selectedDomain === 'all' ? 'all' : selectedDomain %></span>
      </div>
    </div>

    <form method="get" action="/mailboxes" class="inline-form" style="margin-bottom:0.8rem;">
      <label>Domain
        <select name="domain">
          <option value="all" <%= selectedDomain === 'all' ? 'selected' : '' %>>All</option>
          <% domains.forEach((domain) => { %>
            <option value="<%= domain %>" <%= selectedDomain === domain ? 'selected' : '' %>><%= domain %></option>
          <% }) %>
        </select>
      </label>
      <button class="btn" type="submit"><i data-lucide="filter"></i><span>Apply</span></button>
    </form>

    <div class="table-wrap mailbox-table-wrap">
      <table class="data-table mailbox-table">
        <thead>
          <tr>
            <th>Email</th>
            <th>Name</th>
            <th>Quota</th>
            <th>State</th>
            <th class="actions-col">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if (mailboxRows.length === 0) { %>
            <tr><td colspan="5">No mailboxes found.</td></tr>
          <% } %>
          <% mailboxRows.forEach((mailbox) => { %>
            <tr>
              <td><%= mailbox.username %></td>
              <td><%= mailbox.name %></td>
              <td><%= Math.round((mailbox.quota || 0) / 1024 / 1024) %> MB</td>
              <td>
                <% if (mailbox.localState) { %>
                  <%= mailbox.localState.status %> (warns: <%= mailbox.localState.warn_count %>)
                <% } else { %>
                  active
                <% } %>
              </td>
              <td class="actions-col">
                <div class="action-row action-row-inline">
                  <form method="post" action="/mailboxes/<%= encodeURIComponent(mailbox.username) %>/enable" class="inline-form">
                    <button class="btn mini" type="submit"><i data-lucide="check"></i><span>Enable</span></button>
                  </form>
                  <form method="post" action="/mailboxes/<%= encodeURIComponent(mailbox.username) %>/disable" class="inline-form">
                    <button class="btn mini warn" type="submit"><i data-lucide="pause-circle"></i><span>Disable</span></button>
                  </form>
                  <form method="post" action="/mailboxes/<%= encodeURIComponent(mailbox.username) %>/delete" class="inline-form" onsubmit="return confirm('Delete mailbox <%= mailbox.username %>?');">
                    <button class="btn mini danger" type="submit"><i data-lucide="trash-2"></i><span>Delete</span></button>
                  </form>
                </div>
              </td>
            </tr>
            <tr>
              <td colspan="5">
                <div class="action-row mailbox-edit-row">
                  <form method="post" action="/mailboxes/<%= encodeURIComponent(mailbox.username) %>/quota" class="inline-form">
                    <label>Quota MB <input type="number" name="quotaMb" min="1" required /></label>
                    <button class="btn mini" type="submit"><i data-lucide="database"></i><span>Set Quota</span></button>
                  </form>
                  <form method="post" action="/mailboxes/<%= encodeURIComponent(mailbox.username) %>/password" class="inline-form">
                    <label>New Password <input type="password" name="newPassword" minlength="8" required /></label>
                    <button class="btn mini" type="submit"><i data-lucide="key-round"></i><span>Reset Password</span></button>
                  </form>
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </article>

  <article class="panel-card">
    <div class="card-head">
      <div>
        <h2 class="sub-title">Create Mailbox</h2>
        <p class="muted">Create a mailbox tied to a managed domain with quota controls.</p>
      </div>
      <span class="badge-pill"><i data-lucide="user-plus"></i>new</span>
    </div>

    <form method="post" action="/mailboxes" class="stacked-form">
      <label>Local part
        <input type="text" name="localPart" placeholder="admin" required />
      </label>
      <label>Domain
        <select name="domain" required>
          <% domains.forEach((domain) => { %>
            <option value="<%= domain %>"><%= domain %></option>
          <% }) %>
        </select>
      </label>
      <label>Name
        <input type="text" name="name" placeholder="Mailbox Owner" required />
      </label>
      <label>Password
        <input type="password" name="password" minlength="8" required />
      </label>
      <label>Quota (MB)
        <input type="number" name="quotaMb" value="3072" min="1" required />
      </label>
      <button class="btn primary" type="submit">
        <i data-lucide="mail-plus"></i><span>Create Mailbox</span>
      </button>
    </form>
  </article>
</section>

<%- include('partials/footer') %>
